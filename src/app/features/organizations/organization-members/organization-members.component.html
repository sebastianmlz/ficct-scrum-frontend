<div class="max-w-5xl mx-auto p-6">
	<header class="bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 shadow-lg rounded-b-2xl animate-fade-in mb-8">
		<div class="max-w-5xl mx-auto py-4 px-4 flex items-center gap-4">
			<a routerLink="/organizations" class="text-white hover:text-gray-200 transition-transform transform hover:-translate-x-1">
				<i class="pi pi-arrow-left text-2xl"></i>
			</a>
			<h1 class="text-2xl font-extrabold text-white tracking-wide drop-shadow-lg">Miembros de la organización</h1>
		</div>
	</header>
	<!-- Modal de edición de rol -->
	<div *ngIf="editRoleModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
		<div class="bg-white rounded-xl shadow-xl p-8 w-full max-w-md relative">
			<button (click)="closeEditRoleModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
			<h3 class="text-xl font-bold mb-4 text-primary">Editar rol de miembro</h3>
			<form [formGroup]="roleForm" (ngSubmit)="submitRoleChange()" class="space-y-4">
				<div>
					<label for="editRole" class="block text-sm font-medium text-gray-700">Rol</label>
					<select id="editRole" formControlName="role" class="mt-1 w-full border rounded px-3 py-2">
						<option value="owner">Owner</option>
						<option value="admin">Admin</option>
						<option value="member">Member</option>
					</select>
				</div>
				<div *ngIf="roleError" class="text-red-500 text-sm">{{ roleError }}</div>
				<div *ngIf="roleSuccess" class="text-green-600 text-sm">{{ roleSuccess }}</div>
				<button type="submit" [disabled]="roleLoading" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2.5 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-60">
					<svg *ngIf="roleLoading" class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M4 12a8 8 0 018-8" class="opacity-75"/></svg>
					{{ roleLoading ? 'Actualizando...' : 'Actualizar rol' }}
				</button>
			</form>
		</div>
	</div>
		<div class="flex items-center justify-between mb-6">
			<div></div>
			<button *ngIf="canEditRoles" (click)="openInviteModal()" class="bg-primary hover:bg-primary/90 text-white font-semibold px-5 py-2 rounded-xl shadow-md transition-all duration-200 flex items-center gap-2">
				<i class="pi pi-user-plus text-lg"></i>
				Invitar miembro
			</button>
		</div>
	<!-- Modal de invitación -->
	<div *ngIf="inviteModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
		<div class="bg-white rounded-xl shadow-xl p-8 w-full max-w-md relative">
			<button (click)="closeInviteModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
			<h3 class="text-xl font-bold mb-4 text-primary">Invitar miembro</h3>
			<form [formGroup]="inviteForm" (ngSubmit)="submitInvite()" class="space-y-4">
				<div>
					<label for="inviteEmail" class="block text-sm font-medium text-gray-700">Correo electrónico</label>
					<input id="inviteEmail" type="email" formControlName="email" class="mt-1 w-full border rounded px-3 py-2" placeholder="usuario@email.com" [class.border-red-300]="inviteForm.get('email')?.invalid && inviteForm.get('email')?.touched">
					<div *ngIf="inviteForm.get('email')?.invalid && inviteForm.get('email')?.touched" class="text-red-500 text-xs mt-1">
						<span *ngIf="inviteForm.get('email')?.errors?.['required']">El correo es obligatorio.</span>
						<span *ngIf="inviteForm.get('email')?.errors?.['email']">Correo inválido.</span>
					</div>
				</div>
				<div>
					<label for="inviteRole" class="block text-sm font-medium text-gray-700">Rol</label>
					<select id="inviteRole" formControlName="role" class="mt-1 w-full border rounded px-3 py-2">
						<option value="owner">Owner</option>
						<option value="admin">Admin</option>
						<option value="member">Member</option>
					</select>
				</div>
				<div *ngIf="inviteError" class="text-red-500 text-sm">{{ inviteError }}</div>
				<div *ngIf="inviteSuccess" class="text-green-600 text-sm">{{ inviteSuccess }}</div>
				<button type="submit" [disabled]="inviteLoading" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2.5 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-60">
					<svg *ngIf="inviteLoading" class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M4 12a8 8 0 018-8" class="opacity-75"/></svg>
					{{ inviteLoading ? 'Enviando...' : 'Enviar invitación' }}
				</button>
			</form>
		</div>
	</div>

	<p *ngIf="error" class="text-red-500 mb-4">{{ error }}</p>

	<p-progressSpinner *ngIf="loading" styleClass="mx-auto block" strokeWidth="4" fill="var(--surface-ground)" animationDuration=".5s"></p-progressSpinner>

	<!-- Tabla de miembros -->
	<div *ngIf="!loading && members?.length" class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
		<div class="overflow-x-auto">
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-gray-50">
					<tr>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invitado por</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
					</tr>
				</thead>
				<tbody class="bg-white divide-y divide-gray-200">
					<tr *ngFor="let member of members" class="hover:bg-gray-50 transition-colors">
						<td class="px-6 py-4 whitespace-nowrap">
							<div class="flex items-center">
								<div class="flex-shrink-0 h-10 w-10">
									<div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm shadow-sm">
										{{ member.user.full_name.charAt(0).toUpperCase() }}
									</div>
								</div>
								<div class="ml-4">
									<div class="text-sm font-medium text-gray-900">{{ member.user.full_name }}</div>
								</div>
							</div>
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<div class="text-sm text-gray-600">{{ member.user.email }}</div>
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<div class="flex items-center gap-2">
								<span [ngClass]="{
									'bg-purple-100 text-purple-800 border border-purple-200': member.role === 'owner',
									'bg-blue-100 text-blue-800 border border-blue-200': member.role === 'admin',
									'bg-gray-100 text-gray-800 border border-gray-200': member.role === 'member'
								}" class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
									{{ member.role }}
								</span>
								<button *ngIf="canEditRoles" (click)="openEditRoleModal(member)" 
									class="ml-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1.5 rounded transition-colors" 
									title="Editar rol">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
									</svg>
								</button>
							</div>
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<span [ngClass]="{
								'bg-green-100 text-green-800 border border-green-200': member.status === 'active',
								'bg-red-100 text-red-800 border border-red-200': member.status !== 'active'
							}" class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
								{{ member.status }}
							</span>
						</td>
						<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
							{{ member.invited_by.full_name || '-' }}
						</td>
						<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
							{{ member.invited_at | date:'short' }}
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Invitaciones pendientes -->
	<div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
		<div class="bg-amber-50 border-b border-amber-200 px-6 py-4">
			<h3 class="text-lg font-semibold text-amber-900 flex items-center gap-2">
				<svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
				</svg>
				Invitaciones pendientes
			</h3>
		</div>
		
		<p-progressSpinner *ngIf="invitationsLoading" styleClass="mx-auto block" strokeWidth="4" fill="var(--surface-ground)" animationDuration=".5s"></p-progressSpinner>
		<div *ngIf="invitationsError" class="text-red-500 px-6 py-4">{{ invitationsError }}</div>
		
		<div *ngIf="!invitationsLoading && invitations?.length" class="overflow-x-auto">
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-gray-50">
					<tr>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correo</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invitado por</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enviada</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expira</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
					</tr>
				</thead>
				<tbody class="bg-white divide-y divide-gray-200">
					<tr *ngFor="let inv of invitations" class="hover:bg-gray-50 transition-colors">
						<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ inv.email }}</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 border border-gray-200 capitalize">
								{{ inv.role }}
							</span>
						</td>
						<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
							{{ inv.invited_by.full_name || '-' }}
						</td>
						<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
							{{ inv.invited_at | date:'short' }}
						</td>
						<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
							{{ inv.expires_at | date:'short' }}
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<span [ngClass]="{
								'bg-yellow-100 text-yellow-800 border border-yellow-200': inv.status === 'pending',
								'bg-green-100 text-green-800 border border-green-200': inv.status === 'accepted',
								'bg-red-100 text-red-800 border border-red-200': inv.status === 'expired' || inv.status === 'cancelled'
							}" class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
								{{ inv.status }}
							</span>
						</td>
						<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
							<div class="flex items-center gap-2">
								<button 
									[disabled]="inv.status !== 'pending'"
									(click)="resendInvitation(inv.id)"
									class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1.5 rounded transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
									title="Reenviar invitación">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
									</svg>
								</button>
								<button 
									[disabled]="inv.status !== 'pending'"
									(click)="cancelInvitation(inv.id)"
									class="text-red-600 hover:text-red-800 hover:bg-red-50 p-1.5 rounded transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
									title="Cancelar invitación">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
									</svg>
								</button>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		
		<div *ngIf="!invitationsLoading && (!invitations || !invitations.length) && !invitationsError" class="px-6 py-8 text-center text-gray-500">
			<svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
			</svg>
			<p>No hay invitaciones pendientes</p>
		</div>
	</div>	<div *ngIf="!loading && (!members || !members.length) && !error" class="text-gray-500 text-center py-8">
		No hay miembros en esta organización.
	</div>
</div>
